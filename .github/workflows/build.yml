name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9  # v4.3.1
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build -c Release --no-restore
    
    - name: Generate SBOM (Software Bill of Materials)
      run: |
        dotnet tool install --global Microsoft.Sbom.DotNetTool
        sbom-tool generate -b ./bin/Release -bc ./UnlockOpenFile.csproj -pn UnlockOpenFile -pv ${{ github.ref_name }} -ps trollgameskr -nsb https://github.com/trollgameskr/UnlockOpenFile
      continue-on-error: true
    
    - name: Publish (Self-contained)
      run: dotnet publish -c Release -r win-x64 --self-contained true -o ./publish-standalone -p:SourceRevisionId=${{ github.sha }}
    
    - name: Publish (Framework-dependent)
      run: dotnet publish -c Release -r win-x64 --self-contained false -o ./publish -p:SourceRevisionId=${{ github.sha }}
    
    - name: Create ZIP archives
      run: |
        # Create README files for each build with verification info
        @"
        UnlockOpenFile ${{ github.ref_name }} - Standalone Build
        ================================================
        
        Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build Environment: GitHub Actions (Windows)
        Source Commit: ${{ github.sha }}
        Source Repository: https://github.com/trollgameskr/UnlockOpenFile
        
        This is a standalone build that includes .NET Runtime.
        No additional dependencies are required.
        
        SECURITY VERIFICATION:
        - Source code: https://github.com/trollgameskr/UnlockOpenFile/tree/${{ github.sha }}
        - Build workflow: https://github.com/trollgameskr/UnlockOpenFile/blob/${{ github.sha }}/.github/workflows/build.yml
        - This build is reproducible and can be verified by building from source
        
        Binary SHA256: $($(Get-FileHash -Algorithm SHA256 './publish-standalone/UnlockOpenFile.exe').Hash)
        
        "@ | Out-File -FilePath "./publish-standalone/BUILD_INFO.txt" -Encoding utf8
        
        @"
        UnlockOpenFile ${{ github.ref_name }} - Framework-dependent Build
        ================================================
        
        Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build Environment: GitHub Actions (Windows)
        Source Commit: ${{ github.sha }}
        Source Repository: https://github.com/trollgameskr/UnlockOpenFile
        
        This is a framework-dependent build that requires .NET 8.0 Runtime.
        
        SECURITY VERIFICATION:
        - Source code: https://github.com/trollgameskr/UnlockOpenFile/tree/${{ github.sha }}
        - Build workflow: https://github.com/trollgameskr/UnlockOpenFile/blob/${{ github.sha }}/.github/workflows/build.yml
        - This build is reproducible and can be verified by building from source
        
        Binary SHA256: $($(Get-FileHash -Algorithm SHA256 './publish/UnlockOpenFile.exe').Hash)
        
        "@ | Out-File -FilePath "./publish/BUILD_INFO.txt" -Encoding utf8
        
        # Create ZIP with optimal compression and preserve metadata
        # Use -CompressionLevel Optimal for better compression
        # This creates cleaner archives that may be less suspicious to antivirus
        Compress-Archive -Path ./publish-standalone/* -DestinationPath UnlockOpenFile-${{ github.ref_name }}-standalone.zip -CompressionLevel Optimal -Force
        Compress-Archive -Path ./publish/* -DestinationPath UnlockOpenFile-${{ github.ref_name }}.zip -CompressionLevel Optimal -Force
        
        # Generate file hashes for binaries inside archives
        Write-Host "Standalone Build Binary Hash:"
        Get-FileHash -Algorithm SHA256 "./publish-standalone/UnlockOpenFile.exe" | Format-List
        Write-Host "Framework-dependent Build Binary Hash:"
        Get-FileHash -Algorithm SHA256 "./publish/UnlockOpenFile.exe" | Format-List
      shell: pwsh
    
    - name: Calculate checksums
      run: |
        $standaloneHash = (Get-FileHash -Algorithm SHA256 "UnlockOpenFile-${{ github.ref_name }}-standalone.zip").Hash
        $regularHash = (Get-FileHash -Algorithm SHA256 "UnlockOpenFile-${{ github.ref_name }}.zip").Hash
        $standaloneBinaryHash = (Get-FileHash -Algorithm SHA256 "./publish-standalone/UnlockOpenFile.exe").Hash
        $regularBinaryHash = (Get-FileHash -Algorithm SHA256 "./publish/UnlockOpenFile.exe").Hash
        
        @"
        SHA256 Checksums:
        
        ZIP Archives:
        - UnlockOpenFile-${{ github.ref_name }}-standalone.zip: $standaloneHash
        - UnlockOpenFile-${{ github.ref_name }}.zip: $regularHash
        
        Binaries (inside ZIPs):
        - Standalone UnlockOpenFile.exe: $standaloneBinaryHash
        - Framework-dependent UnlockOpenFile.exe: $regularBinaryHash
        
        Build Information:
        - Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        - Source commit: ${{ github.sha }}
        - GitHub Actions Runner: windows-latest
        - .NET SDK version: 8.0.x
        
        Verification:
        - Source: https://github.com/trollgameskr/UnlockOpenFile/tree/${{ github.sha }}
        - Workflow: https://github.com/trollgameskr/UnlockOpenFile/blob/${{ github.sha }}/.github/workflows/build.yml
        
        "@ | Out-File -FilePath checksums.txt -Encoding utf8
        
        # Display for logs
        Get-Content checksums.txt
        
        # Set as environment variable for release notes
        "STANDALONE_SHA256=$standaloneHash" >> $env:GITHUB_ENV
        "REGULAR_SHA256=$regularHash" >> $env:GITHUB_ENV
        "STANDALONE_BINARY_SHA256=$standaloneBinaryHash" >> $env:GITHUB_ENV
        "REGULAR_BINARY_SHA256=$regularBinaryHash" >> $env:GITHUB_ENV
      shell: pwsh
    
    - name: Create Release with GitHub CLI
      run: |
        $releaseBody = @"
        ## UnlockOpenFile ${{ github.ref_name }}
        
        ### ğŸ“¥ ë‹¤ìš´ë¡œë“œ
        
        **â­ ê¶Œì¥: Standalone ë¹Œë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”**
        
        - **UnlockOpenFile-${{ github.ref_name }}-standalone.zip** (ê¶Œì¥)
          - .NET Runtimeì´ í¬í•¨ëœ ìì²´ í¬í•¨í˜• ë¹Œë“œ
          - ë³„ë„ì˜ .NET Runtime ì„¤ì¹˜ ë¶ˆí•„ìš”
          - âœ… Windows Defender ì˜¤íƒ ê°€ëŠ¥ì„± ë‚®ìŒ
          - íŒŒì¼ í¬ê¸°: ì•½ 70MB
        
        - **UnlockOpenFile-${{ github.ref_name }}.zip** (ê³ ê¸‰ ì‚¬ìš©ììš©)
          - .NET 8.0 Runtimeì´ í•„ìš”í•œ ê²½ëŸ‰ ë¹Œë“œ
          - âš ï¸ Windows Defenderê°€ Trojan:Script/Wacatac.B!mlë¡œ ì˜¤íƒí•  ìˆ˜ ìˆìŒ
          - ReadyToRun ë° SingleFile ìµœì í™” ì ìš©
          - íŒŒì¼ í¬ê¸°: ì•½ 5MB
          - .NET 8.0 Runtimeì´ ì´ë¯¸ ì„¤ì¹˜ëœ í™˜ê²½ì—ì„œë§Œ ê¶Œì¥
        
        ### ğŸ›¡ï¸ ë³´ì•ˆ ì•ˆë‚´
        
        **Windows Defender ì˜¤íƒ (False Positive) ì•Œë¦¼:**
        
        ì´ í”„ë¡œê·¸ë¨ì€ ì™„ì „íˆ ì•ˆì „í•œ ì˜¤í”ˆì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´ì…ë‹ˆë‹¤. Windows Defenderê°€ ë°”ì´ëŸ¬ìŠ¤ë¡œ íƒì§€í•  ìˆ˜ ìˆìœ¼ë‚˜, ì´ëŠ” ì˜¤íƒ(False Positive)ì…ë‹ˆë‹¤.
        
        - âœ… **ì†ŒìŠ¤ ì½”ë“œ ê³µê°œ**: ëª¨ë“  ì½”ë“œê°€ GitHubì—ì„œ ê²€ì¦ ê°€ëŠ¥í•©ë‹ˆë‹¤
        - âœ… **MIT ë¼ì´ì„ ìŠ¤**: ììœ ë¡­ê²Œ ì‚¬ìš© ê°€ëŠ¥í•œ ì˜¤í”ˆì†ŒìŠ¤ì…ë‹ˆë‹¤
        - âœ… **ì•…ì„± ì½”ë“œ ì—†ìŒ**: ë„¤íŠ¸ì›Œí¬ í†µì‹ , ë°ì´í„° ìˆ˜ì§‘ ë“± ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë™ì‘ì´ ì—†ìŠµë‹ˆë‹¤
        
        **ì™œ ê²½ëŸ‰ ë¹Œë“œë§Œ ì˜¤íƒë˜ë‚˜ìš”?**
        - ê²½ëŸ‰ ë¹Œë“œëŠ” ì‘ì€ í¬ê¸°ì™€ ë™ì  ë¡œë”© íŠ¹ì„± ë•Œë¬¸ì— íœ´ë¦¬ìŠ¤í‹± ë¶„ì„ì—ì„œ ì˜ì‹¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        - Standalone ë¹Œë“œëŠ” .NET Runtimeì„ í¬í•¨í•˜ì—¬ ë” ì™„ì „í•œ PE êµ¬ì¡°ë¥¼ ê°€ì§€ë¯€ë¡œ ì˜¤íƒì´ ì ìŠµë‹ˆë‹¤
        - ì˜¤íƒì´ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” íŒŒì¼ ëª¨ë‹ˆí„°ë§, í”„ë¡œì„¸ìŠ¤ ì¶”ì , ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì ‘ê·¼ ë“±ì˜ ì •ìƒ ê¸°ëŠ¥ ë•Œë¬¸ì…ë‹ˆë‹¤
        
        **í•´ê²° ë°©ë²•:**
        - ğŸŒŸ **ê°€ì¥ ì‰¬ìš´ ë°©ë²•**: Standalone ë¹Œë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš” (ì˜¤íƒ ê°€ëŠ¥ì„± ë‚®ìŒ)
        - ìì„¸í•œ í•´ê²° ë°©ë²•ì€ [SECURITY.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/SECURITY.md) ë° [WINDOWS_DEFENDER_FIX.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/WINDOWS_DEFENDER_FIX.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”
        
        ### ğŸ” íŒŒì¼ ê²€ì¦
        
        **SHA256 Checksums (ZIP Archives):**
        \`\`\`
        UnlockOpenFile-${{ github.ref_name }}-standalone.zip: $env:STANDALONE_SHA256
        UnlockOpenFile-${{ github.ref_name }}.zip: $env:REGULAR_SHA256
        \`\`\`
        
        **SHA256 Checksums (Binaries):**
        \`\`\`
        Standalone UnlockOpenFile.exe: $env:STANDALONE_BINARY_SHA256
        Framework-dependent UnlockOpenFile.exe: $env:REGULAR_BINARY_SHA256
        \`\`\`
        
        **ë¹Œë“œ íˆ¬ëª…ì„±:**
        - ì†ŒìŠ¤ ì»¤ë°‹: [${{ github.sha }}](https://github.com/trollgameskr/UnlockOpenFile/tree/${{ github.sha }})
        - ë¹Œë“œ ì›Œí¬í”Œë¡œìš°: [build.yml](https://github.com/trollgameskr/UnlockOpenFile/blob/${{ github.sha }}/.github/workflows/build.yml)
        - ë¹Œë“œ ë¡œê·¸: [GitHub Actions Run](https://github.com/trollgameskr/UnlockOpenFile/actions)
        - ê° ZIP íŒŒì¼ ì•ˆì— BUILD_INFO.txt íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆì–´ ë¹Œë“œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        
        **VirusTotal ê²€ì‚¬:**
        - ë‹¤ìš´ë¡œë“œ í›„ [VirusTotal](https://www.virustotal.com)ì— ì—…ë¡œë“œí•˜ì—¬ ì—¬ëŸ¬ ë³´ì•ˆ ì—”ì§„ì˜ ê²€ì‚¬ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        - Standalone ë¹Œë“œëŠ” ëŒ€ë¶€ë¶„ì˜ ë³´ì•ˆ ì—”ì§„ì—ì„œ ì•ˆì „í•œ ê²ƒìœ¼ë¡œ íŒì •ë©ë‹ˆë‹¤
        
        **ìì²´ ë¹Œë“œë¡œ ê²€ì¦:**
        \`\`\`bash
        git clone https://github.com/trollgameskr/UnlockOpenFile.git
        cd UnlockOpenFile
        git checkout ${{ github.sha }}
        dotnet publish -c Release -r win-x64 --self-contained true -o ./publish-standalone
        # ìƒì„±ëœ ë°”ì´ë„ˆë¦¬ì˜ SHA256ì„ ìœ„ì˜ í•´ì‹œì™€ ë¹„êµí•˜ì„¸ìš”
        \`\`\`
        
        ### ğŸ“‹ ìš”êµ¬ ì‚¬í•­
        
        **Standalone ë¹Œë“œ:**
        - Windows 10 ì´ìƒ
        
        **ê²½ëŸ‰ ë¹Œë“œ:**
        - Windows 10 ì´ìƒ
        - [.NET 8.0 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) í•„ìš”
        
        ### ğŸš€ ì‚¬ìš© ë°©ë²•
        
        1. ZIP íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì••ì¶•ì„ í’‰ë‹ˆë‹¤
        2. UnlockOpenFile.exeë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
        3. ìì„¸í•œ ì‚¬ìš©ë²•ì€ [README.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/README.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”
        
        ### ğŸ“– ì˜¤í”ˆì†ŒìŠ¤
        
        ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ í•˜ì— ë°°í¬ë˜ëŠ” ë¬´ë£Œ ì˜¤í”ˆì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´ì…ë‹ˆë‹¤. [ì†ŒìŠ¤ ì½”ë“œ](https://github.com/trollgameskr/UnlockOpenFile)ë¥¼ ì§ì ‘ í™•ì¸í•˜ê³  ë¹Œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        "@
        gh release create ${{ github.ref_name }} `
          UnlockOpenFile-${{ github.ref_name }}-standalone.zip `
          UnlockOpenFile-${{ github.ref_name }}.zip `
          checksums.txt `
          --title "UnlockOpenFile ${{ github.ref_name }}" `
          --notes "$releaseBody"
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
