name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9  # v4.3.1
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build -c Release --no-restore
    
    - name: Generate SBOM (Software Bill of Materials)
      run: |
        dotnet tool install --global Microsoft.Sbom.DotNetTool
        sbom-tool generate -b ./bin/Release -bc ./UnlockOpenFile.csproj -pn UnlockOpenFile -pv ${{ github.ref_name }} -ps trollgameskr -nsb https://github.com/trollgameskr/UnlockOpenFile
      continue-on-error: true
    
    - name: Publish (Self-contained)
      run: dotnet publish -c Release -r win-x64 --self-contained true -o ./publish-standalone -p:SourceRevisionId=${{ github.sha }}
    
    - name: Publish (Framework-dependent)
      run: dotnet publish -c Release -r win-x64 --self-contained false -o ./publish -p:SourceRevisionId=${{ github.sha }}
    
    - name: Create ZIP archives
      run: |
        # Create README files for each build with verification info
        @"
        UnlockOpenFile ${{ github.ref_name }} - Standalone Build
        ================================================
        
        Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build Environment: GitHub Actions (Windows)
        Source Commit: ${{ github.sha }}
        Source Repository: https://github.com/trollgameskr/UnlockOpenFile
        
        This is a standalone build that includes .NET Runtime.
        No additional dependencies are required.
        
        SECURITY VERIFICATION:
        - Source code: https://github.com/trollgameskr/UnlockOpenFile/tree/${{ github.sha }}
        - Build workflow: https://github.com/trollgameskr/UnlockOpenFile/blob/${{ github.sha }}/.github/workflows/build.yml
        - This build is reproducible and can be verified by building from source
        
        Binary SHA256: $($(Get-FileHash -Algorithm SHA256 './publish-standalone/UnlockOpenFile.exe').Hash)
        
        "@ | Out-File -FilePath "./publish-standalone/BUILD_INFO.txt" -Encoding utf8
        
        @"
        UnlockOpenFile ${{ github.ref_name }} - Framework-dependent Build
        ================================================
        
        Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build Environment: GitHub Actions (Windows)
        Source Commit: ${{ github.sha }}
        Source Repository: https://github.com/trollgameskr/UnlockOpenFile
        
        This is a framework-dependent build that requires .NET 8.0 Runtime.
        
        SECURITY VERIFICATION:
        - Source code: https://github.com/trollgameskr/UnlockOpenFile/tree/${{ github.sha }}
        - Build workflow: https://github.com/trollgameskr/UnlockOpenFile/blob/${{ github.sha }}/.github/workflows/build.yml
        - This build is reproducible and can be verified by building from source
        
        Binary SHA256: $($(Get-FileHash -Algorithm SHA256 './publish/UnlockOpenFile.exe').Hash)
        
        "@ | Out-File -FilePath "./publish/BUILD_INFO.txt" -Encoding utf8
        
        # Create ZIP with optimal compression and preserve metadata
        # Use -CompressionLevel Optimal for better compression
        # This creates cleaner archives that may be less suspicious to antivirus
        Compress-Archive -Path ./publish-standalone/* -DestinationPath UnlockOpenFile-${{ github.ref_name }}-standalone.zip -CompressionLevel Optimal -Force
        Compress-Archive -Path ./publish/* -DestinationPath UnlockOpenFile-${{ github.ref_name }}.zip -CompressionLevel Optimal -Force
        
        # Generate file hashes for binaries inside archives
        Write-Host "Standalone Build Binary Hash:"
        Get-FileHash -Algorithm SHA256 "./publish-standalone/UnlockOpenFile.exe" | Format-List
        Write-Host "Framework-dependent Build Binary Hash:"
        Get-FileHash -Algorithm SHA256 "./publish/UnlockOpenFile.exe" | Format-List
      shell: pwsh
    
    - name: Calculate checksums
      run: |
        $standaloneHash = (Get-FileHash -Algorithm SHA256 "UnlockOpenFile-${{ github.ref_name }}-standalone.zip").Hash
        $regularHash = (Get-FileHash -Algorithm SHA256 "UnlockOpenFile-${{ github.ref_name }}.zip").Hash
        $standaloneBinaryHash = (Get-FileHash -Algorithm SHA256 "./publish-standalone/UnlockOpenFile.exe").Hash
        $regularBinaryHash = (Get-FileHash -Algorithm SHA256 "./publish/UnlockOpenFile.exe").Hash
        
        @"
        SHA256 Checksums:
        
        ZIP Archives:
        - UnlockOpenFile-${{ github.ref_name }}-standalone.zip: $standaloneHash
        - UnlockOpenFile-${{ github.ref_name }}.zip: $regularHash
        
        Binaries (inside ZIPs):
        - Standalone UnlockOpenFile.exe: $standaloneBinaryHash
        - Framework-dependent UnlockOpenFile.exe: $regularBinaryHash
        
        Build Information:
        - Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        - Source commit: ${{ github.sha }}
        - GitHub Actions Runner: windows-latest
        - .NET SDK version: 8.0.x
        
        Verification:
        - Source: https://github.com/trollgameskr/UnlockOpenFile/tree/${{ github.sha }}
        - Workflow: https://github.com/trollgameskr/UnlockOpenFile/blob/${{ github.sha }}/.github/workflows/build.yml
        
        "@ | Out-File -FilePath checksums.txt -Encoding utf8
        
        # Display for logs
        Get-Content checksums.txt
        
        # Set as environment variable for release notes
        "STANDALONE_SHA256=$standaloneHash" >> $env:GITHUB_ENV
        "REGULAR_SHA256=$regularHash" >> $env:GITHUB_ENV
        "STANDALONE_BINARY_SHA256=$standaloneBinaryHash" >> $env:GITHUB_ENV
        "REGULAR_BINARY_SHA256=$regularBinaryHash" >> $env:GITHUB_ENV
      shell: pwsh
    
    - name: Create Release with GitHub CLI
      run: |
        $releaseBody = @"
        ## UnlockOpenFile ${{ github.ref_name }}
        
        ### 📥 다운로드
        
        **⭐ 권장: Standalone 빌드를 사용하세요**
        
        - **UnlockOpenFile-${{ github.ref_name }}-standalone.zip** (권장)
          - .NET Runtime이 포함된 자체 포함형 빌드
          - 별도의 .NET Runtime 설치 불필요
          - ✅ Windows Defender 오탐 가능성 낮음
          - 파일 크기: 약 70MB
        
        - **UnlockOpenFile-${{ github.ref_name }}.zip** (고급 사용자용)
          - .NET 8.0 Runtime이 필요한 경량 빌드
          - ⚠️ Windows Defender가 Trojan:Script/Wacatac.B!ml로 오탐할 수 있음
          - ReadyToRun 및 SingleFile 최적화 적용
          - 파일 크기: 약 5MB
          - .NET 8.0 Runtime이 이미 설치된 환경에서만 권장
        
        ### 🛡️ 보안 안내
        
        **Windows Defender 오탐 (False Positive) 알림:**
        
        이 프로그램은 완전히 안전한 오픈소스 소프트웨어입니다. Windows Defender가 바이러스로 탐지할 수 있으나, 이는 오탐(False Positive)입니다.
        
        - ✅ **소스 코드 공개**: 모든 코드가 GitHub에서 검증 가능합니다
        - ✅ **MIT 라이선스**: 자유롭게 사용 가능한 오픈소스입니다
        - ✅ **악성 코드 없음**: 네트워크 통신, 데이터 수집 등 의심스러운 동작이 없습니다
        
        **왜 경량 빌드만 오탐되나요?**
        - 경량 빌드는 작은 크기와 동적 로딩 특성 때문에 휴리스틱 분석에서 의심될 수 있습니다
        - Standalone 빌드는 .NET Runtime을 포함하여 더 완전한 PE 구조를 가지므로 오탐이 적습니다
        - 오탐이 발생하는 이유는 파일 모니터링, 프로세스 추적, 레지스트리 접근 등의 정상 기능 때문입니다
        
        **해결 방법:**
        - 🌟 **가장 쉬운 방법**: Standalone 빌드를 사용하세요 (오탐 가능성 낮음)
        - 자세한 해결 방법은 [SECURITY.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/SECURITY.md) 및 [WINDOWS_DEFENDER_FIX.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/WINDOWS_DEFENDER_FIX.md)를 참조하세요
        
        ### 🔐 파일 검증
        
        **SHA256 Checksums (ZIP Archives):**
        \`\`\`
        UnlockOpenFile-${{ github.ref_name }}-standalone.zip: $env:STANDALONE_SHA256
        UnlockOpenFile-${{ github.ref_name }}.zip: $env:REGULAR_SHA256
        \`\`\`
        
        **SHA256 Checksums (Binaries):**
        \`\`\`
        Standalone UnlockOpenFile.exe: $env:STANDALONE_BINARY_SHA256
        Framework-dependent UnlockOpenFile.exe: $env:REGULAR_BINARY_SHA256
        \`\`\`
        
        **빌드 투명성:**
        - 소스 커밋: [${{ github.sha }}](https://github.com/trollgameskr/UnlockOpenFile/tree/${{ github.sha }})
        - 빌드 워크플로우: [build.yml](https://github.com/trollgameskr/UnlockOpenFile/blob/${{ github.sha }}/.github/workflows/build.yml)
        - 빌드 로그: [GitHub Actions Run](https://github.com/trollgameskr/UnlockOpenFile/actions)
        - 각 ZIP 파일 안에 BUILD_INFO.txt 파일이 포함되어 있어 빌드 정보를 확인할 수 있습니다
        
        **VirusTotal 검사:**
        - 다운로드 후 [VirusTotal](https://www.virustotal.com)에 업로드하여 여러 보안 엔진의 검사 결과를 확인할 수 있습니다
        - Standalone 빌드는 대부분의 보안 엔진에서 안전한 것으로 판정됩니다
        
        **자체 빌드로 검증:**
        \`\`\`bash
        git clone https://github.com/trollgameskr/UnlockOpenFile.git
        cd UnlockOpenFile
        git checkout ${{ github.sha }}
        dotnet publish -c Release -r win-x64 --self-contained true -o ./publish-standalone
        # 생성된 바이너리의 SHA256을 위의 해시와 비교하세요
        \`\`\`
        
        ### 📋 요구 사항
        
        **Standalone 빌드:**
        - Windows 10 이상
        
        **경량 빌드:**
        - Windows 10 이상
        - [.NET 8.0 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) 필요
        
        ### 🚀 사용 방법
        
        1. ZIP 파일을 다운로드하여 압축을 풉니다
        2. UnlockOpenFile.exe를 실행합니다
        3. 자세한 사용법은 [README.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/README.md)를 참조하세요
        
        ### 📖 오픈소스
        
        이 프로젝트는 MIT 라이선스 하에 배포되는 무료 오픈소스 소프트웨어입니다. [소스 코드](https://github.com/trollgameskr/UnlockOpenFile)를 직접 확인하고 빌드할 수 있습니다.
        "@
        gh release create ${{ github.ref_name }} `
          UnlockOpenFile-${{ github.ref_name }}-standalone.zip `
          UnlockOpenFile-${{ github.ref_name }}.zip `
          checksums.txt `
          --title "UnlockOpenFile ${{ github.ref_name }}" `
          --notes "$releaseBody"
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
