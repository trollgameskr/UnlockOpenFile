name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9  # v4.3.1
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build -c Release --no-restore
    
    - name: Publish (Self-contained)
      run: dotnet publish -c Release -r win-x64 --self-contained true -o ./publish-standalone
    
    - name: Publish (Framework-dependent)
      run: dotnet publish -c Release -r win-x64 --self-contained false -o ./publish
    
    - name: Create ZIP archives
      run: |
        Compress-Archive -Path ./publish-standalone/* -DestinationPath UnlockOpenFile-${{ github.ref_name }}-standalone.zip
        Compress-Archive -Path ./publish/* -DestinationPath UnlockOpenFile-${{ github.ref_name }}.zip
      shell: pwsh
    
    - name: Calculate checksums
      run: |
        $standaloneHash = (Get-FileHash -Algorithm SHA256 "UnlockOpenFile-${{ github.ref_name }}-standalone.zip").Hash
        $regularHash = (Get-FileHash -Algorithm SHA256 "UnlockOpenFile-${{ github.ref_name }}.zip").Hash
        
        @"
        SHA256 Checksums:
        - UnlockOpenFile-${{ github.ref_name }}-standalone.zip: $standaloneHash
        - UnlockOpenFile-${{ github.ref_name }}.zip: $regularHash
        "@ | Out-File -FilePath checksums.txt -Encoding utf8
        
        # Display for logs
        Get-Content checksums.txt
        
        # Set as environment variable for release notes
        "STANDALONE_SHA256=$standaloneHash" >> $env:GITHUB_ENV
        "REGULAR_SHA256=$regularHash" >> $env:GITHUB_ENV
      shell: pwsh
    
    - name: Create Release with GitHub CLI
      run: |
        $releaseBody = @"
        ## UnlockOpenFile ${{ github.ref_name }}
        
        ### ğŸ“¥ ë‹¤ìš´ë¡œë“œ
        
        **â­ ê¶Œì¥: Standalone ë¹Œë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”**
        
        - **UnlockOpenFile-${{ github.ref_name }}-standalone.zip** (ê¶Œì¥)
          - .NET Runtimeì´ í¬í•¨ëœ ìì²´ í¬í•¨í˜• ë¹Œë“œ
          - ë³„ë„ì˜ .NET Runtime ì„¤ì¹˜ ë¶ˆí•„ìš”
          - âœ… Windows Defender ì˜¤íƒ ê°€ëŠ¥ì„± ë‚®ìŒ
          - íŒŒì¼ í¬ê¸°: ì•½ 70MB
        
        - **UnlockOpenFile-${{ github.ref_name }}.zip** (ê³ ê¸‰ ì‚¬ìš©ììš©)
          - .NET 8.0 Runtimeì´ í•„ìš”í•œ ê²½ëŸ‰ ë¹Œë“œ
          - âš ï¸ Windows Defenderê°€ Trojan:Script/Wacatac.B!mlë¡œ ì˜¤íƒí•  ìˆ˜ ìˆìŒ
          - ReadyToRun ë° SingleFile ìµœì í™” ì ìš©
          - íŒŒì¼ í¬ê¸°: ì•½ 5MB
          - .NET 8.0 Runtimeì´ ì´ë¯¸ ì„¤ì¹˜ëœ í™˜ê²½ì—ì„œë§Œ ê¶Œì¥
        
        ### ğŸ›¡ï¸ ë³´ì•ˆ ì•ˆë‚´
        
        **Windows Defender ì˜¤íƒ (False Positive) ì•Œë¦¼:**
        
        ì´ í”„ë¡œê·¸ë¨ì€ ì™„ì „íˆ ì•ˆì „í•œ ì˜¤í”ˆì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´ì…ë‹ˆë‹¤. Windows Defenderê°€ ë°”ì´ëŸ¬ìŠ¤ë¡œ íƒì§€í•  ìˆ˜ ìˆìœ¼ë‚˜, ì´ëŠ” ì˜¤íƒ(False Positive)ì…ë‹ˆë‹¤.
        
        - âœ… **ì†ŒìŠ¤ ì½”ë“œ ê³µê°œ**: ëª¨ë“  ì½”ë“œê°€ GitHubì—ì„œ ê²€ì¦ ê°€ëŠ¥í•©ë‹ˆë‹¤
        - âœ… **MIT ë¼ì´ì„ ìŠ¤**: ììœ ë¡­ê²Œ ì‚¬ìš© ê°€ëŠ¥í•œ ì˜¤í”ˆì†ŒìŠ¤ì…ë‹ˆë‹¤
        - âœ… **ì•…ì„± ì½”ë“œ ì—†ìŒ**: ë„¤íŠ¸ì›Œí¬ í†µì‹ , ë°ì´í„° ìˆ˜ì§‘ ë“± ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë™ì‘ì´ ì—†ìŠµë‹ˆë‹¤
        
        **ì™œ ê²½ëŸ‰ ë¹Œë“œë§Œ ì˜¤íƒë˜ë‚˜ìš”?**
        - ê²½ëŸ‰ ë¹Œë“œëŠ” ì‘ì€ í¬ê¸°ì™€ ë™ì  ë¡œë”© íŠ¹ì„± ë•Œë¬¸ì— íœ´ë¦¬ìŠ¤í‹± ë¶„ì„ì—ì„œ ì˜ì‹¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        - Standalone ë¹Œë“œëŠ” .NET Runtimeì„ í¬í•¨í•˜ì—¬ ë” ì™„ì „í•œ PE êµ¬ì¡°ë¥¼ ê°€ì§€ë¯€ë¡œ ì˜¤íƒì´ ì ìŠµë‹ˆë‹¤
        - ì˜¤íƒì´ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” íŒŒì¼ ëª¨ë‹ˆí„°ë§, í”„ë¡œì„¸ìŠ¤ ì¶”ì , ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì ‘ê·¼ ë“±ì˜ ì •ìƒ ê¸°ëŠ¥ ë•Œë¬¸ì…ë‹ˆë‹¤
        
        **í•´ê²° ë°©ë²•:**
        - ğŸŒŸ **ê°€ì¥ ì‰¬ìš´ ë°©ë²•**: Standalone ë¹Œë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš” (ì˜¤íƒ ê°€ëŠ¥ì„± ë‚®ìŒ)
        - ìì„¸í•œ í•´ê²° ë°©ë²•ì€ [SECURITY.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/SECURITY.md) ë° [WINDOWS_DEFENDER_FIX.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/WINDOWS_DEFENDER_FIX.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”
        
        ### ğŸ” íŒŒì¼ ê²€ì¦
        
        **SHA256 Checksums:**
        \`\`\`
        UnlockOpenFile-${{ github.ref_name }}-standalone.zip: $env:STANDALONE_SHA256
        UnlockOpenFile-${{ github.ref_name }}.zip: $env:REGULAR_SHA256
        \`\`\`
        
        **VirusTotal ê²€ì‚¬:**
        - ë‹¤ìš´ë¡œë“œ í›„ [VirusTotal](https://www.virustotal.com)ì— ì—…ë¡œë“œí•˜ì—¬ ì—¬ëŸ¬ ë³´ì•ˆ ì—”ì§„ì˜ ê²€ì‚¬ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        - Standalone ë¹Œë“œëŠ” ëŒ€ë¶€ë¶„ì˜ ë³´ì•ˆ ì—”ì§„ì—ì„œ ì•ˆì „í•œ ê²ƒìœ¼ë¡œ íŒì •ë©ë‹ˆë‹¤
        
        ### ğŸ“‹ ìš”êµ¬ ì‚¬í•­
        
        **Standalone ë¹Œë“œ:**
        - Windows 10 ì´ìƒ
        
        **ê²½ëŸ‰ ë¹Œë“œ:**
        - Windows 10 ì´ìƒ
        - [.NET 8.0 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) í•„ìš”
        
        ### ğŸš€ ì‚¬ìš© ë°©ë²•
        
        1. ZIP íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì••ì¶•ì„ í’‰ë‹ˆë‹¤
        2. UnlockOpenFile.exeë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
        3. ìì„¸í•œ ì‚¬ìš©ë²•ì€ [README.md](https://github.com/trollgameskr/UnlockOpenFile/blob/main/README.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”
        
        ### ğŸ“– ì˜¤í”ˆì†ŒìŠ¤
        
        ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ í•˜ì— ë°°í¬ë˜ëŠ” ë¬´ë£Œ ì˜¤í”ˆì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´ì…ë‹ˆë‹¤. [ì†ŒìŠ¤ ì½”ë“œ](https://github.com/trollgameskr/UnlockOpenFile)ë¥¼ ì§ì ‘ í™•ì¸í•˜ê³  ë¹Œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        "@
        gh release create ${{ github.ref_name }} `
          UnlockOpenFile-${{ github.ref_name }}-standalone.zip `
          UnlockOpenFile-${{ github.ref_name }}.zip `
          checksums.txt `
          --title "UnlockOpenFile ${{ github.ref_name }}" `
          --notes "$releaseBody"
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
